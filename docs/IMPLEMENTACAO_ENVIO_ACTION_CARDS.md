# üìã Implementa√ß√£o de Envio de Action Cards - Refer√™ncia para Monitoramento Autom√°tico

## üéØ **Objetivo**
Este documento serve como refer√™ncia para implementar o envio autom√°tico de action cards no sistema de monitoramento a cada 60 segundos, usando a mesma l√≥gica do envio individual que foi corrigida.

## ‚úÖ **L√≥gica de Envio Corrigida**

### **1. Estrutura dos Dados do Paciente**
```javascript
// Dados convertidos da API CAM Krolik
const patient = {
  id: "68cb4b7fd579f3d3fe9d6a7e",           // ID do atendimento
  contactId: "68b1ff1281153b38b7009959",    // ID do contato (OBRIGAT√ìRIO para envio)
  name: "Felipe",
  phone: "5519995068303",                   // N√∫mero de telefone (OBRIGAT√ìRIO para envio)
  sectorId: "64d4db384f04cb80ac059912",
  sectorName: "Suporte Geral",
  channelId: "63e68f168a48875131856df8",
  channelType: "WhatsApp Business (Principal)",
  waitStartTime: "2025-09-17T23:59:59.244Z",
  waitTimeMinutes: 20,
  status: "waiting"
};
```

### **2. Fun√ß√£o de Envio de Action Card**
```javascript
/**
 * Envia cart√£o de a√ß√£o seguindo o modelo do curl da API CAM Krolik
 * @param {Object} payload - Dados do envio
 * @param {string} payload.number - N√∫mero de telefone do paciente
 * @param {string} payload.contactId - ID do contato (N√ÉO o attendanceId)
 * @param {string} payload.action_card_id - ID do action card
 * @param {boolean} payload.forceSend - For√ßar envio (padr√£o: true)
 * @returns {Promise<Object>} Resposta da API
 */
async sendActionCard(payload) {
  try {
    // Validar payload obrigat√≥rio
    if (!payload.number || !payload.contactId || !payload.action_card_id) {
      throw new Error('Payload incompleto: number, contactId e action_card_id s√£o obrigat√≥rios');
    }

    // Preparar payload seguindo exatamente o modelo do curl
    const requestPayload = {
      number: payload.number,
      contactId: payload.contactId,
      action_card_id: payload.action_card_id,
      forceSend: payload.forceSend !== undefined ? payload.forceSend : true
    };

    console.log(`üì§ Enviando action card para ${payload.number}:`, requestPayload);

    const response = await this.axiosInstance.post('/core/v2/api/chats/send-action-card', requestPayload, {
      headers: {
        'accept': 'application/json',
        'access-token': this.token,
        'Content-Type': 'application/json-patch+json'
      }
    });

    console.log(`üì§ Cart√£o de a√ß√£o enviado com sucesso para ${payload.number}`);
    return response.data;
  } catch (error) {
    console.error(`‚ùå Erro ao enviar cart√£o de a√ß√£o para ${payload.number}:`, error.message);
    if (error.response) {
      console.error('üìã Detalhes do erro:', {
        status: error.response.status,
        data: error.response.data
      });
    }
    throw error;
  }
}
```

### **3. Payload Correto para API CAM Krolik**
```javascript
// Modelo do curl que deve ser seguido:
const payload = {
  number: "5519995068303",                    // N√∫mero de telefone do paciente
  contactId: "68b1ff1281153b38b7009959",     // ID do contato (chat.contact.id)
  action_card_id: "631f2b4f307d23f46ac80a2b", // ID do action card
  forceSend: true                             // For√ßar envio
};

// Headers obrigat√≥rios:
const headers = {
  'accept': 'application/json',
  'access-token': 'SEU_TOKEN_AQUI',
  'Content-Type': 'application/json-patch+json'
};
```

## üîÑ **Resposta de Sucesso da API**
```json
{
  "status": "202",
  "msg": "Successfully added to the transmission queue",
  "currentChatId": "68cb4b7fd579f3d3fe9d6a7e",
  "messageSentId": ""
}
```

## üö® **Erros Comuns e Solu√ß√µes**

### **Erro 400 - N√∫mero Inv√°lido**
```json
{
  "status": "400",
  "msg": "The number 68cb4b7fd579f3d3fe9d6a7e is invalid, check the problem INVALID_WA_NUMBER",
  "errorCode": "num_04"
}
```
**Causa**: Usar `attendanceId` como `contactId`
**Solu√ß√£o**: Usar `chat.contact.id` como `contactId`

### **Erro 400 - Payload Incompleto**
```json
{
  "status": "400",
  "msg": "Missing required fields"
}
```
**Causa**: Campos obrigat√≥rios ausentes
**Solu√ß√£o**: Validar `number`, `contactId` e `action_card_id`

## üéØ **Implementa√ß√£o no Monitoramento Autom√°tico**

### **1. Crit√©rios de Elegibilidade**
```javascript
// Pacientes eleg√≠veis para mensagem de 30 minutos
function getEligiblePatientsFor30MinMessage(patients, configManager) {
  return patients.filter(patient => {
    // Crit√©rio: 30 minutos ou mais de espera
    const waitTimeOk = patient.waitTimeMinutes >= 30;
    
    // Crit√©rio: Dentro do hor√°rio comercial
    const businessHoursOk = isWithinBusinessHours();
    
    // Crit√©rio: Dia √∫til
    const workingDayOk = isWorkingDay();
    
    // Crit√©rio: Setor n√£o exclu√≠do
    const sectorNotExcluded = !configManager.isAttendanceExcluded(
      `${patient.name}_${patient.phone}_${patient.sectorId}`
    );
    
    // Crit√©rio: Paciente n√£o processado anteriormente
    const notProcessed = !jsonPatientManager.isPatientProcessed(patient.id);
    
    return waitTimeOk && businessHoursOk && workingDayOk && 
           sectorNotExcluded && notProcessed;
  });
}
```

### **2. Processamento de Pacientes Eleg√≠veis**
```javascript
async function processEligiblePatients(eligiblePatients, actionCardId) {
  const results = [];
  let successCount = 0;
  let failedCount = 0;

  for (const patient of eligiblePatients) {
    try {
      // Preparar payload seguindo a l√≥gica corrigida
      const payload = {
        number: patient.phone,           // N√∫mero de telefone
        contactId: patient.contactId,    // ID do contato (N√ÉO attendanceId)
        action_card_id: actionCardId,    // ID do action card configurado
        forceSend: true
      };

      console.log(`ü§ñ [AUTOM√ÅTICO] Enviando action card para ${patient.name} (${patient.phone})`);

      // Enviar via API CAM Krolik
      const response = await krolikApiClient.sendActionCard(payload);
      
      // Marcar como processado
      await jsonPatientManager.markPatientAsProcessed(patient.id);
      
      // Adicionar √† lista de exclus√£o para evitar reenvios
      configManager.addAttendanceExclusion(
        `${patient.name}_${patient.phone}_${patient.sectorId}`
      );

      results.push({
        patientId: patient.id,
        patientName: patient.name,
        phone: patient.phone,
        success: true,
        message: 'Enviado automaticamente',
        response: response
      });
      
      successCount++;
      
    } catch (error) {
      console.error(`‚ùå [AUTOM√ÅTICO] Falha ao enviar para ${patient.name}:`, error.message);
      
      results.push({
        patientId: patient.id,
        patientName: patient.name,
        phone: patient.phone,
        success: false,
        error: error.message
      });
      
      failedCount++;
    }
  }

  // Log do resultado
  console.log(`ü§ñ [AUTOM√ÅTICO] Resultado: ${successCount} sucessos, ${failedCount} falhas`);
  
  return {
    success: successCount,
    failed: failedCount,
    results: results
  };
}
```

### **3. Integra√ß√£o no Ciclo de Monitoramento**
```javascript
// No MonitoringService.ts - m√©todo checkWaitingPatients()
async function checkWaitingPatients() {
  try {
    // 1. Buscar pacientes da API CAM Krolik
    const currentPatients = await krolikClient.listWaitingAttendances();
    
    // 2. Atualizar dados no JsonPatientManager
    await jsonPatientManager.updateActivePatients(currentPatients);
    
    // 3. Verificar pacientes eleg√≠veis para mensagem de 30 minutos
    const eligibleFor30Min = getEligiblePatientsFor30MinMessage(
      currentPatients, 
      configManager
    );
    
    // 4. Enviar mensagens se houver pacientes eleg√≠veis
    if (eligibleFor30Min.length > 0) {
      const actionCardId = configManager.getSelectedActionCard30Min();
      
      if (actionCardId) {
        console.log(`ü§ñ [AUTOM√ÅTICO] Encontrados ${eligibleFor30Min.length} pacientes eleg√≠veis para mensagem de 30 minutos`);
        
        const result = await processEligiblePatients(eligibleFor30Min, actionCardId);
        
        // Registrar m√©tricas
        metricsService.recordAutomaticMessageSent(result.success, result.failed);
      } else {
        console.log(`‚ö†Ô∏è [AUTOM√ÅTICO] Nenhum action card de 30 minutos configurado`);
      }
    }
    
    return currentPatients;
    
  } catch (error) {
    console.error('‚ùå Erro no ciclo de monitoramento:', error);
    throw error;
  }
}
```

## üìä **Mapeamento de Setores**
```javascript
// Fun√ß√£o para mapear IDs de setores para nomes
function getSectorName(sectorId) {
  const sectorMap = {
    '64d4db384f04cb80ac059912': 'Suporte Geral',
    '631f7d27307d23f46af88983': 'Administrativo/Financeiro',
    '6400efb5343817d4ddbb2a4c': 'Suporte CAM',
    '6401f4f49b1ff8512b525e9c': 'Suporte Telefonia'
  };
  
  return sectorMap[sectorId] || `Setor ${sectorId}`;
}
```

## üîß **Configura√ß√µes Necess√°rias**

### **1. Action Cards Configurados**
- ‚úÖ Action card para mensagem de 30 minutos
- ‚úÖ Action card para mensagem de fim de dia (18h)
- ‚úÖ Action cards devem ter IDs v√°lidos da API CAM Krolik

### **2. Lista de Exclus√µes**
- ‚úÖ Setores exclu√≠dos por ID
- ‚úÖ Canais exclu√≠dos por ID
- ‚úÖ Pacientes individuais (nome + telefone + setor)

### **3. Hor√°rios de Funcionamento**
- ‚úÖ Hor√°rio comercial configurado
- ‚úÖ Dias √∫teis configurados
- ‚úÖ Timezone Bras√≠lia

## üß™ **Testes de Valida√ß√£o**

### **1. Teste de Envio Individual**
```bash
node examples/test-send-action-card.js
```

### **2. Teste de Elegibilidade**
```javascript
// Verificar se pacientes s√£o marcados como eleg√≠veis corretamente
const patients = await krolikClient.listWaitingAttendances();
const eligible = getEligiblePatientsFor30MinMessage(patients, configManager);
console.log(`Pacientes eleg√≠veis: ${eligible.length}`);
```

### **3. Teste de Processamento**
```javascript
// Testar envio autom√°tico sem marcar como processado
const result = await processEligiblePatients(testPatients, actionCardId);
console.log(`Resultado: ${result.success} sucessos, ${result.failed} falhas`);
```

## üìù **Logs Importantes**

### **Sucesso**
```
ü§ñ [AUTOM√ÅTICO] Enviando action card para Felipe (5519995068303)
üì§ Cart√£o de a√ß√£o enviado com sucesso para 5519995068303
ü§ñ [AUTOM√ÅTICO] Resultado: 1 sucessos, 0 falhas
```

### **Falha**
```
‚ùå [AUTOM√ÅTICO] Falha ao enviar para Ana Paula: Request failed with status code 400
üìã Detalhes do erro: { status: 400, data: { ... } }
ü§ñ [AUTOM√ÅTICO] Resultado: 0 sucessos, 1 falhas
```

## üéØ **Pontos Cr√≠ticos para Implementa√ß√£o**

1. **‚úÖ Usar `contactId` correto** - `chat.contact.id`, n√£o `chat.attendanceId`
2. **‚úÖ Validar payload obrigat√≥rio** - `number`, `contactId`, `action_card_id`
3. **‚úÖ Headers corretos** - `Content-Type: application/json-patch+json`
4. **‚úÖ Marcar como processado** - Evitar reenvios
5. **‚úÖ Adicionar √† exclus√£o** - Lista de pacientes j√° notificados
6. **‚úÖ Logs detalhados** - Para debugging e monitoramento
7. **‚úÖ Tratamento de erros** - Continuar processamento mesmo com falhas

---

**üìã Este documento deve ser consultado sempre que implementar o envio autom√°tico de action cards no sistema de monitoramento a cada 60 segundos.**
