#!/usr/bin/env node

/**
 * Debug espec√≠fico para o paciente Felipe (5519995068303)
 */

const fs = require('fs').promises;

class DebugPacienteFelipe {
  constructor() {
    this.telefoneFilipe = '5519995068303';
    this.nomeFilipe = 'Felipe';
  }

  async executarDebug() {
    console.log('üîç ===========================================');
    console.log('   DEBUG PACIENTE FELIPE');
    console.log('===========================================');
    console.log(`üì± Telefone: ${this.telefoneFilipe}`);
    console.log(`üë§ Nome: ${this.nomeFilipe}`);
    console.log(`‚è∞ An√°lise em: ${new Date().toLocaleString('pt-BR')}`);
    console.log('===========================================\n');

    try {
      // 1. Encontrar dados do Felipe
      const dadosFelipe = await this.encontrarDadosFelipe();
      
      // 2. Verificar configura√ß√£o atual
      const config = await this.verificarConfiguracao();
      
      // 3. Analisar elegibilidade detalhada
      await this.analisarElegibilidade(dadosFelipe, config);
      
      // 4. Verificar se foi processado
      await this.verificarSeProcessado(dadosFelipe);
      
      // 5. Simular l√≥gica do sistema
      await this.simularLogicaSistema(dadosFelipe, config);

    } catch (error) {
      console.error('‚ùå Erro no debug:', error.message);
    }
  }

  async encontrarDadosFelipe() {
    console.log('üë§ Procurando dados do Felipe...');
    
    try {
      const pacientesData = await fs.readFile('data/patients_active.json', 'utf8');
      const pacientes = JSON.parse(pacientesData);
      
      const felipe = pacientes.find(p => 
        p.phone === this.telefoneFilipe || 
        p.name === this.nomeFilipe
      );
      
      if (!felipe) {
        console.log('‚ùå Felipe n√£o encontrado no arquivo patients_active.json');
        return null;
      }
      
      console.log('‚úÖ Felipe encontrado!');
      console.log('üìã Dados completos:');
      console.log(`   ID: ${felipe.id}`);
      console.log(`   Nome: ${felipe.name}`);
      console.log(`   Telefone: ${felipe.phone}`);
      console.log(`   Contact ID: ${felipe.contactId}`);
      console.log(`   Setor: ${felipe.sectorName} (${felipe.sectorId})`);
      console.log(`   Canal: ${felipe.channelType} (${felipe.channelId})`);
      console.log(`   Status: ${felipe.status}`);
      console.log(`   In√≠cio da espera: ${felipe.waitStartTime}`);
      console.log(`   Tempo de espera registrado: ${felipe.waitTimeMinutes} min`);
      console.log(`   Entrou em: ${felipe.enteredAt}`);
      
      // Calcular tempo de espera atual
      const agora = new Date();
      const inicioEspera = new Date(felipe.waitStartTime);
      const tempoEsperaAtual = Math.floor((agora - inicioEspera) / (1000 * 60));
      
      console.log(`   ‚è∞ Tempo de espera ATUAL: ${tempoEsperaAtual} min`);
      console.log(`   üìä Diferen√ßa: arquivo(${felipe.waitTimeMinutes}) vs atual(${tempoEsperaAtual})`);
      
      return { ...felipe, tempoEsperaAtual };
      
    } catch (error) {
      console.log('‚ùå Erro ao ler arquivo de pacientes:', error.message);
      return null;
    }
  }

  async verificarConfiguracao() {
    console.log('\n‚öôÔ∏è Verificando configura√ß√£o atual...');
    
    try {
      const configData = await fs.readFile('data/system_config.json', 'utf8');
      const config = JSON.parse(configData);
      
      const configuracao = {
        minWaitTime: parseInt(config.minWaitTime) || 30,
        maxWaitTime: parseInt(config.maxWaitTime) || 40,
        flowPaused: config.flowPaused === 'true',
        endOfDayPaused: config.endOfDayPaused === 'true',
        ignoreBusinessHours: config.ignoreBusinessHours === 'true',
        refreshInterval: parseInt(config.refreshInterval) || 120,
        selectedActionCard30Min: config.selectedActionCard30Min,
        selectedActionCardEndDay: config.selectedActionCardEndDay
      };
      
      console.log('üìã Configura√ß√£o carregada:');
      console.log(`   ‚è∞ Janela de tempo: ${configuracao.minWaitTime} - ${configuracao.maxWaitTime} min`);
      console.log(`   ‚è∏Ô∏è Fluxo pausado: ${configuracao.flowPaused}`);
      console.log(`   üåÖ Fim de dia pausado: ${configuracao.endOfDayPaused}`);
      console.log(`   üïê Ignorar hor√°rio comercial: ${configuracao.ignoreBusinessHours}`);
      console.log(`   üîÑ Intervalo de verifica√ß√£o: ${configuracao.refreshInterval}s`);
      console.log(`   üìã Action Card 30min: ${configuracao.selectedActionCard30Min}`);
      console.log(`   üìã Action Card fim de dia: ${configuracao.selectedActionCardEndDay}`);
      
      return configuracao;
      
    } catch (error) {
      console.log('‚ùå Erro ao ler configura√ß√£o:', error.message);
      return null;
    }
  }

  async analisarElegibilidade(felipe, config) {
    if (!felipe || !config) {
      console.log('\n‚ùå N√£o √© poss√≠vel analisar elegibilidade - dados faltando');
      return;
    }
    
    console.log('\nüéØ Analisando elegibilidade do Felipe...');
    
    const agora = new Date();
    const horaAtual = agora.getHours();
    const diaAtual = agora.getDay(); // 0=domingo, 1=segunda, etc.
    
    console.log(`üìÖ Contexto atual:`);
    console.log(`   ‚è∞ Hora atual: ${horaAtual}h`);
    console.log(`   üìÖ Dia da semana: ${diaAtual} (${this.getDayName(diaAtual)})`);
    console.log(`   üïê √â hor√°rio comercial: ${horaAtual >= 8 && horaAtual < 18 ? 'SIM' : 'N√ÉO'}`);
    console.log(`   üìÖ √â dia √∫til: ${diaAtual >= 1 && diaAtual <= 5 ? 'SIM' : 'N√ÉO'}`);
    
    console.log(`\nüìä Crit√©rios de elegibilidade:`);
    
    // 1. Tempo de espera
    const tempoEspera = felipe.tempoEsperaAtual;
    const dentroJanela = tempoEspera >= config.minWaitTime && tempoEspera <= config.maxWaitTime;
    console.log(`   1. ‚è∞ Tempo de espera: ${tempoEspera} min`);
    console.log(`      Janela permitida: ${config.minWaitTime} - ${config.maxWaitTime} min`);
    console.log(`      Status: ${dentroJanela ? '‚úÖ DENTRO' : '‚ùå FORA'} da janela`);
    
    if (!dentroJanela) {
      if (tempoEspera < config.minWaitTime) {
        console.log(`      üí° Muito cedo: faltam ${config.minWaitTime - tempoEspera} min`);
      } else {
        console.log(`      üí° Muito tarde: passou ${tempoEspera - config.maxWaitTime} min do limite`);
      }
    }
    
    // 2. Fluxo pausado
    console.log(`   2. ‚è∏Ô∏è Fluxo pausado: ${config.flowPaused ? '‚ùå SIM' : '‚úÖ N√ÉO'}`);
    
    // 3. Hor√°rio comercial (se n√£o ignorar)
    const isBusinessHours = horaAtual >= 8 && horaAtual < 18;
    const isWorkingDay = diaAtual >= 1 && diaAtual <= 5;
    
    if (config.ignoreBusinessHours) {
      console.log(`   3. üïê Hor√°rio comercial: ‚úÖ IGNORADO (configurado para 24h)`);
    } else {
      console.log(`   3. üïê Hor√°rio comercial: ${isBusinessHours ? '‚úÖ SIM' : '‚ùå N√ÉO'}`);
      console.log(`   4. üìÖ Dia √∫til: ${isWorkingDay ? '‚úÖ SIM' : '‚ùå N√ÉO'}`);
    }
    
    // Resultado final
    let elegivel = dentroJanela && !config.flowPaused;
    
    if (!config.ignoreBusinessHours) {
      elegivel = elegivel && isBusinessHours && isWorkingDay;
    }
    
    console.log(`\nüéØ RESULTADO FINAL:`);
    console.log(`   Felipe est√° ${elegivel ? '‚úÖ ELEG√çVEL' : '‚ùå N√ÉO ELEG√çVEL'} para receber mensagem`);
    
    if (!elegivel) {
      console.log(`\nüí° Motivos da n√£o elegibilidade:`);
      if (!dentroJanela) {
        console.log(`   - ‚è∞ Fora da janela de tempo (${tempoEspera} min n√£o est√° entre ${config.minWaitTime}-${config.maxWaitTime})`);
      }
      if (config.flowPaused) {
        console.log(`   - ‚è∏Ô∏è Fluxo est√° pausado`);
      }
      if (!config.ignoreBusinessHours && !isBusinessHours) {
        console.log(`   - üïê Fora do hor√°rio comercial (${horaAtual}h)`);
      }
      if (!config.ignoreBusinessHours && !isWorkingDay) {
        console.log(`   - üìÖ N√£o √© dia √∫til (${this.getDayName(diaAtual)})`);
      }
    }
    
    return elegivel;
  }

  async verificarSeProcessado(felipe) {
    if (!felipe) return;
    
    console.log('\nüìã Verificando se Felipe j√° foi processado...');
    
    try {
      // Verificar arquivo de processados
      const processedData = await fs.readFile('data/patients_processed.json', 'utf8');
      const processados = JSON.parse(processedData);
      
      const felipeProcessado = processados.find(p => 
        p.id === felipe.id || 
        p.phone === felipe.phone
      );
      
      if (felipeProcessado) {
        console.log('‚ùå Felipe J√Å foi processado!');
        console.log(`   üìÖ Processado em: ${felipeProcessado.processedAt}`);
        console.log(`   üìã Tipo de mensagem: ${felipeProcessado.messageType || 'N/A'}`);
        console.log(`   üì§ Action Card: ${felipeProcessado.actionCardId || 'N/A'}`);
      } else {
        console.log('‚úÖ Felipe N√ÉO foi processado ainda');
      }
      
      return !!felipeProcessado;
      
    } catch (error) {
      console.log('‚ö†Ô∏è Erro ao verificar processados (arquivo pode n√£o existir):', error.message);
      return false;
    }
  }

  async simularLogicaSistema(felipe, config) {
    if (!felipe || !config) return;
    
    console.log('\nüîÑ Simulando l√≥gica do sistema...');
    
    try {
      // Simular a l√≥gica do MonitoringService.isPatientEligibleFor30MinMessage
      console.log('üìã Executando l√≥gica do MonitoringService:');
      
      const tempoEspera = felipe.tempoEsperaAtual;
      
      // 1. Verificar tempo de espera
      if (!tempoEspera || tempoEspera < config.minWaitTime || tempoEspera > config.maxWaitTime) {
        console.log(`   ‚ùå Falhou no crit√©rio 1: Tempo de espera (${tempoEspera} min)`);
        return false;
      }
      console.log(`   ‚úÖ Passou no crit√©rio 1: Tempo de espera (${tempoEspera} min)`);
      
      // 2. Verificar se j√° foi processado (simulado)
      const jaProcessado = await this.verificarSeProcessado(felipe);
      if (jaProcessado) {
        console.log(`   ‚ùå Falhou no crit√©rio 2: J√° foi processado`);
        return false;
      }
      console.log(`   ‚úÖ Passou no crit√©rio 2: N√£o foi processado`);
      
      // 3. Verificar lista de exclus√µes (simulado - assumindo que n√£o est√°)
      console.log(`   ‚úÖ Passou no crit√©rio 3: N√£o est√° na lista de exclus√µes (assumido)`);
      
      // 4. Verificar hor√°rio comercial
      const agora = new Date();
      const horaAtual = agora.getHours();
      const diaAtual = agora.getDay();
      
      if (!config.ignoreBusinessHours) {
        const isBusinessHours = horaAtual >= 8 && horaAtual < 18;
        if (!isBusinessHours) {
          console.log(`   ‚ùå Falhou no crit√©rio 4: Fora do hor√°rio comercial (${horaAtual}h)`);
          return false;
        }
        console.log(`   ‚úÖ Passou no crit√©rio 4: Dentro do hor√°rio comercial (${horaAtual}h)`);
        
        // 5. Verificar dia √∫til
        const isWorkingDay = diaAtual >= 1 && diaAtual <= 5;
        if (!isWorkingDay) {
          console.log(`   ‚ùå Falhou no crit√©rio 5: N√£o √© dia √∫til (${this.getDayName(diaAtual)})`);
          return false;
        }
        console.log(`   ‚úÖ Passou no crit√©rio 5: √â dia √∫til (${this.getDayName(diaAtual)})`);
      } else {
        console.log(`   ‚úÖ Passou nos crit√©rios 4-5: Hor√°rio comercial ignorado`);
      }
      
      // 6. Verificar se fluxo n√£o est√° pausado
      if (config.flowPaused) {
        console.log(`   ‚ùå Falhou no crit√©rio 6: Fluxo est√° pausado`);
        return false;
      }
      console.log(`   ‚úÖ Passou no crit√©rio 6: Fluxo n√£o est√° pausado`);
      
      console.log(`\nüéâ RESULTADO: Felipe deveria ser ELEG√çVEL segundo a l√≥gica do sistema!`);
      return true;
      
    } catch (error) {
      console.log('‚ùå Erro na simula√ß√£o:', error.message);
      return false;
    }
  }

  getDayName(dayNumber) {
    const days = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
    return days[dayNumber] || 'Desconhecido';
  }
}

// Executar debug
async function main() {
  const debug = new DebugPacienteFelipe();
  await debug.executarDebug();
}

// Executar se chamado diretamente
if (require.main === module) {
  main();
}

module.exports = { DebugPacienteFelipe };
